# 32单片机学习记录7之EXTI外部中断

## 前置

### 疑问1

**我刚学了串口通信中SR寄存器和CR1寄存器设置了中断使能，SR中接收中断状态位变成1，就可以产生中断信号，进而触发STM32F407内部NVIC控制器执行一些操作。 这是属于片上外设：就是芯片内部串口控制器产生的中断信号。 片外外设也可以产生中断信号，这种叫EXTI外部中断？两者的区别？**

**片上外设中断（内部外设中断）：**

- 指的是芯片内部集成的外设（如串口、定时器、ADC等）产生的中断
- 以您描述的串口中断为例，是由STM32F407芯片内部的串口控制器直接产生
- **中断信号直接通过芯片内部的中断控制器（NVIC）进行管理**
- 中断源来自于芯片内部的外设寄存器状态变化
- **配置和触发相对简单，因为是芯片内部直接实现的机制**

**外部中断（EXTI）：**

- 指来自芯片外部的中断信号
- **通常由连接到GPIO引脚的外部器件触发**
- 可以是：
  - 传感器
  - 按键
  - 外部芯片的中断输出引脚
  - 其他电子模块的中断信号
- 需要通过GPIO配置和EXTI线路进行中断管理
- 触发方式更加灵活，可以配置上升沿、下降沿或双边沿触发

**主要区别：**

- 中断源位置：内部（片上外设）vs 外部（GPIO引脚）
- 中断管理方式：内部直接管理 vs 需要通过EXTI线路转换
- 配置复杂度：内部中断相对简单 vs 外部中断需要更多配置

**串口中断：**

- 确实是典型的片上外设中断
- 由串口控制器内部状态变化（如接收到数据）触发
  - 接收中断

**外部按键中断：**

- 使用EXTI中断是最佳实践
- 您指出了不能持续扫描的关键点。轮询（高速扫描）会：
  - 浪费大量CPU资源
  - 增加功耗
  - 降低系统实时性
- 中断机制可以让CPU在按键未触发时处于低功耗状态

**光电传感器中断：**

- 同样非常适合使用EXTI中断
- 传感器状态变化不可预测
- 中断可以立即响应状态改变
- 避免了持续轮询带来的资源浪费

您的理解展示了中断的两个核心优势：

- 实时响应
- 节省计算资源

这种中断驱动的编程思想在嵌入式系统中至关重要，尤其是对于需要低功耗和高响应性的应用。

**两种中断最终都会通过NVIC（嵌套向量中断控制器）进行最终的中断处理和优先级管理。**



### 疑问2

**片外外设不能像片上外设那样直接产生中断信号给nvic,需要通过EXTI间接传递中断信号？那是不是需要实现约定什么条件会触发中断？因为不像片上外设一样直接设置对应的中断使能然后等待SR状态寄存器变化即可？**

您的理解很准确。对于片外外设，中断传递确实需要一些额外的步骤：

**中断信号传递流程：**

- 片外外设 → GPIO引脚 → EXTI → NVIC
- 不像片上外设可以直接连接到NVIC

**中断触发条件配置： 需要配置以下几个关键部分：**

- GPIO配置：选择中断引脚
- EXTI配置：
  - 设置触发模式（上升沿/下降沿/双边沿）
  - 使能/屏蔽中断线
- NVIC配置：
  - 设置中断优先级
  - 使能对应中断

具体配置示例（以STM32为例）：

```c
// GPIO配置为输入
GPIO_InitStructure.Mode = GPIO_MODE_IT_RISING; // 上升沿触发

// EXTI配置
EXTI_InitStructure.Mode = EXTI_MODE_INTERRUPT;
EXTI_InitStructure.Trigger = EXTI_TRIGGER_RISING; // 上升沿触发
EXTI_InitStructure.Line = EXTI_LINE;

// NVIC配置
NVIC_InitStructure.NVIC_IRQChannel = EXTI_IRQn;
NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0x00;
```

多了EXTI控制器的配置。一些附加GPIO口的设置。

**关键区别：**

- 片上外设：直接通过寄存器状态触发
- 片外外设：需要额外配置触发条件和传递路径

**触发条件的重要性：**

- 定义何时认为"中断事件发生"
- 可以是电平变化、边沿变化等
- 避免误触发很关键

总之，片外外设中断需要更多的"翻译"和"配置"工作，以将外部信号转换为可被处理的中断信号。

### 疑问3

**如果像这种需要高速扫描的不知道何时发生的程序，都改用中断方式的话，是不是能节省很多CPU资源？**

是的！使用中断而不是轮询（高速扫描）确实可以显著节省CPU资源。让我详细解释一下：

轮询（高速扫描）的问题：

1. CPU持续运行
2. 大量无意义的重复检查
3. 功耗高
4. 资源利用效率低
5. 实时性较差

中断方式的优势：

1. CPU可以进入休眠/低功耗模式
2. 事件发生时立即响应
3. 极大地降低功耗
4. 提高系统实时性
5. 更加节能和高效

举个具体例子：

- **轮询方式：CPU每毫秒都要检查传感器状态**
- **中断方式：传感器状态变化时才唤醒CPU**

典型应用场景：

- 按键检测
- 传感器监测
- 通信接口状态监听
- 外部事件响应

使用中断不仅节省资源，还能：

- 降低系统功耗
- 提高响应速度
- 优化程序结构
- 减少不必要的计算负担

对于资源受限的嵌入式系统尤其重要，可以将宝贵的计算资源用于更有意义的任务。



**我的流水灯是利用计数思想，使用主函数的while（1）运行，如果此时我在后面加一个按键扫描会发现流水灯的速度跟之前有很大差别**

这是典型的轮询带来的性能影响示例！让我详细解释一下原因：

**原始流水灯实现：**

- 在while(1)中持续执行流水灯闪烁逻辑
- **每个延时周期相对稳定**
- **代码执行时间可预测**

**添加按键扫描后的变化：**

- 按键扫描会增加主循环的执行时间
- 每次循环的实际时间变得不确定
  - **每次没有检测到还好，万一检测到按键按下了会进入响应的逻辑，更加耽误实践**
- 流水灯的闪烁间隔被延长和不稳定

性能影响的本质：

- 轮询会"拖慢"主循环执行速度
- 增加的代码逻辑会占用CPU时间
- **原本简单的延时周期被打乱**

改进建议：

1. 使用定时器中断实现流水灯
2. 使用按键中断替代轮询扫描
3. 将流水灯和按键逻辑解耦

这正是我们之前讨论的轮询 vs 中断的典型场景。中断可以：

- 保持流水灯闪烁的稳定性
- 提高系统响应效率
- 减少主循环的负担

## 什么是EXTI中断？

GPIO口电平发生变化,EXTI控制器就可以产生中断信号给到NVIC控制器.

EXTI：外部中断/事件控制器

使用场景：

只要是IO口电平发生变化，要执行一些事情，就可以用外部中断线中断。

​	①外部中断按键 (开机按键,唤醒按键)  

​	②记录脉冲个数

​	③检测设备挂载情况(传感器)

综上:如果IO口的电平发生变化,想及时知道并且执行相应的处理,用EXTI外部中断控制器监测



### 工作原理

**EXTI一边可以通过设置连接到A~H的某一组GPIO引脚，EXTI内部有寄存器可以设置每一个GPIO口单独的中断触发条件，EXTI另一边就是连接着NVIC，传递中断信号给nvic?**

是的,您完全理解正确。EXTI的工作原理可以总结如下:

1. EXTI可以连接到A~H八组GPIO引脚中的任意一组:
   - 通过SYSCFG_EXTICR寄存器选择中断输入引脚
2. EXTI内部有多个中断线(最多23条):
   - 每个中断线都可以单独配置触发条件
   - 比如上升沿触发、下降沿触发或双边沿触发
3. EXTI将这些中断事件传递给NVIC:
   - NVIC负责管理和响应这些外部中断请求
   - 包括中断优先级仲裁和中断服务程序调用

总的来说,EXTI扮演了GPIO引脚与NVIC中断控制器之间的"翻译器"角色:

- 它接收来自GPIO的中断信号
- 根据用户配置进行中断事件的管理
- 最终将中断请求传递给NVIC进行处理



**也就是说EXTI只能连接到GPIO口组是吗？”翻译“GPIO口传递的中断信号？**

不完全正确。**EXTI不仅可以连接到GPIO引脚,还可以连接到其他外设的中断源。EXTI的作用是将来自各种外部中断源的信号"翻译"成可被NVIC处理的中断请求。**

具体来说:

1. EXTI可以连接到GPIO引脚,接收来自GPIO的中断信号。这是EXTI最常见的应用场景。
2. 除了GPIO,EXTI还可以连接到其他外设的中断源,比如:
   - 外部晶振的时钟中断
   - RTC时钟的中断
   - 电源管理电路的中断
3. EXTI的作用是将这些多样化的外部中断源"翻译"成标准的中断信号,并传递给NVIC进行处理。
4. 通过EXTI,用户可以灵活地选择各种外部事件作为中断源,并自由配置中断触发条件,提高系统的灵活性和响应能力。

总之,EXTI不仅可以管理GPIO引脚中断,还能接入其他外部中断源,起到"中断信号翻译器"的作用,将多样化的中断源统一转换给NVIC进行处理。这是EXTI的核心功能。



**所以EXTI可以连接各种外设的中断源，不止GPIO口，只不过SYSCFG外部中断配置寄存器（SYSCFG_EXTICR）可以使GPIO连接到EXTI而已，可能还有寄存器，经过配置可以使其他外设也能连接到EXTI？**

您说得很对。EXTI确实可以连接到各种外设的中断源,不只是GPIO口。

SYSCFG_EXTICR寄存器是用来配置GPIO引脚与EXTI线路的映射关系。但除了这个寄存器,STM32还有其他寄存器可以用来连接其他外设的中断源到EXTI。

具体来说:

1. SYSCFG_EXTICR寄存器用于将GPIO引脚连接到EXTI的特定中断线路上。
2. 对于其他外设,可能会有专门的寄存器来进行中断源与EXTI的连接配置。比如:
   - RTC的中断源可以连接到EXTI
   - 电源管理电路的中断源也可以连接到EXTI
3. 通过这些配置寄存器,用户就可以将各种外部中断源(不仅限于GPIO)与EXTI进行灵活的连接。
4. EXTI负责将这些外部中断源"翻译"成标准的中断信号,然后送给NVIC进行最终的中断处理。

总之,EXTI扮演了一个"中断信号转换器"的角色,能够适配各种外部中断源,提高系统的灵活性和响应能力。关键是要熟悉各个外设的中断源连接方式。

## 如何配置EXTI中断？

### EXTI控制器框图

芯片内部有一个EXTI控制器（**片外外设中断信号翻译器**）,控制器上有23个EXTI接口.

- EXTI0~15连接到GPIO口   EXTI16~22 连接到芯片内部的其他外设

- **每个IO口都可以触发外部中断线中断** (说明：注意分组)		

- 具体配置哪一个IO口连接EXTIx

​			系统配置寄存器（SYSCFG->EXTICR[x]）：管理GPIO口与外部中断线连接

​			具体步骤：

​				①根据自己需要的管脚确定具体的EXTI线

​					PE3------EXTI3

​				②根据具体的EXTI线去找相关寄存器并且确定具体哪四位

​					SYSCFG->EXTICR1        

​				③根据寄存器描述查看写入值

​					PEx 0100



**这个意思是EXTI的中断更加灵活，包括中断信号触发定义。而片上外设的中断信号是固定的？比如串口通信相关寄存器中的接收中断和空闲中断？**

**片上外设中断：**

1. 中断信号相对固定
2. 通常由特定事件触发，如：
   - 串口：
     - 接收中断（数据到达）
     - 发送中断（发送缓冲区空）
     - 空闲中断
   - 定时器：定时中断
   - ADC：转换完成中断
3. 触发条件主要由外设内部状态决定

**EXTI外部中断：**

1. 中断信号极其灵活
2. 触发条件可自由配置：
   - 上升沿触发
   - 下降沿触发
   - 双边沿触发
3. 每个中断线独立控制
   - 可单独使能/屏蔽
   - 有独立的状态位
4. 支持多达23个中断/事件源
5. 可连接到不同的GPIO引脚

**关键区别：**

- 片上外设：预定义的中断触发
- EXTI：用户可高度自定义中断触发条件

**这种灵活性使EXTI特别适合外部事件检测，如传感器、按键等不可预测的信号源。**

### EXTI控制器相关寄存器

①SYSCFG->EXTICR  ：外部中断配置寄存器     //手册第八章节

​		配置GPIO与对应EXTI的映射关系（具体管脚连接EXTIx）

②EXTI->RTSR    ：上升沿触发选择寄存器

​		启动检测上升沿

③EXTI_FTSR    ：下降沿触发选择寄存器

​		启动检测下降沿

④EXTI_IMR     ：中断屏蔽寄存器 

​		使能EXTI线的

⑤EXTI_PR     ：挂起寄存器

​		满足中断条件，此寄存器对应位会自动置1，并向内核NVIC发出中断请求

​		注意：此寄存器需要软件清零

​			 在中断服务函数中的第一件事就是对该位写1（不是写0）

#### 外部中断配置寄存器

**SYSCFG 外部中断配置寄存器 (SYSCFG_EXTICR)的作用是不是和复用功能寄存器一样？后者决定对应GPIO口被复用什么功能，比如串口通信的输入和输出。 前者也是如此：决定芯片内部EXTI外部中断控制器复用那一组GPIO引脚用作外部中断的源输入？ 由此看来GPIO不止简单可以输入输出高低电平，还有复用模式，许多片上外设都要复用GPIO口与片外外设进行信息交换**

复用功能寄存器（GPIO复用）：

- 决定GPIO引脚的复用功能
- 例如：串口、SPI、I2C等外设的引脚功能
- 将GPIO从基本的输入/输出模式切换到特定外设功能

SYSCFG外部中断配置寄存器（SYSCFG_EXTICR）：

- **选择哪个GPIO端口作为EXTI中断源**
- **将特定的GPIO引脚连接到EXTI中断控制器**
- **实现GPIO到中断系统的映射**

GPIO的多种工作模式：

- 通用模式

  - 基本输入模式

  - 基本输出模式

- 复用模式（外设功能）
  - 通信接口（USART、SPI、I2C）
  - 定时器通道
  - 中断输入
  - 模拟输入（ADC）

总结：

- GPIO是非常灵活的外设
- 不仅可以简单地输入输出
- 通过特定寄存器可以实现多种复杂功能
- **是连接芯片内部外设和外部电路的关键接口**

这种设计极大地提高了微控制器的灵活性和功能性。



### EXTI程序设计

```c
总体程序思路
	/*IO控制器配置*/
	/*EXTI控制器配置*/
	/*NVIC控制器配置*/
程序详细配置思路：	
	{
		/*IO控制器配置*/
			//端口时钟使能
			//端口模式配置
			//上下拉
		/*EXTI控制器配置*/
            //系统配置控制器时钟使能
            //将需要用的IO口映射到对应的EXTIx接口上
            //上升沿/下降沿触发
		//中断屏蔽寄存器

		/*NVIC控制器配置*/
			//优先级分组------在主函数
			//计算优先级编码值
			//设置具体中断源
			//使能NVIC响应通道
	}

    中断服务函数
{
//清除中断标志位
//紧急事件
}
说明:如果是9~5  15~10; 进入中断服务函数时候,要判断具体哪个接口触发
```

## 具体使用EXTI中断

