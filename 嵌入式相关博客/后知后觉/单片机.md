# 单片机

## 串口，IIC，SPI通信协议是如何接收数据的

**串口的接收方式主要有两种：**

- **轮询 (Polling):** 主机不断检查接收数据寄存器中是否有新的数据到达。这种方式比较简单，但会消耗主机的处理器资源，因为需要不断地检查。
- **中断 (Interrupt):** 当有新的数据到达时，接收硬件会发出一个中断信号给主机。主机接收到中断后，才会去读取数据。这种方式更有效率，因为主机在没有数据到达时可以执行其他任务。

**SPI**

SPI 是全双工的，数据的发送和接收都是由主机完全掌控。在 SPI 通信中，接收数据通常发生在主机发送数据的同时。当主机通过 MOSI (Master Out Slave In) 线发送一个位的数据给从机时，从机也会同时通过 MISO (Master In Slave Out) 线将一个位的数据发送给主机。因此，主机在发起传输的同时，也就接收来自从机的数据。

**I²C**

关于 I²C，您的疑问在于主机如何感知从机想要发送数据。与 SPI 不同，I²C 并没有一个专门的信号线让从机主动通知主机。在标准的 I²C 通信中，**数据的传输总是 Master 发起的**。

以下是主机从 I²C 从机接收数据的典型流程：

1. **Master 发送起始 (START) 信号：** Master 会在 SDA (Serial Data Line) 线上产生一个由高电平到低电平的跳变，同时 SCL (Serial Clock Line) 维持在高电平。这个信号通知所有连接在 I²C 总线上的从机，通信即将开始。

2. **Master 发送从机地址 (Slave Address) 和读取位：** Master 会紧接着起始信号发送 7 位或 10 位的从机地址，并在最后一个位设置为“读取”位 (通常是逻辑 1)。

3. **从机响应 (Acknowledge, ACK)：** 被寻址到的从机在接收到正确的地址和读取位后，会在下一个时钟周期将 SDA 线拉低，发送一个 ACK 信号给 Master。如果没有从机响应，Master 会知道没有对应的从机存在。

4. **Master 产生时钟并接收数据：** Master 开始产生时钟信号。在每个时钟周期中，被寻址到的从机会将一个位的数据放到 SDA 线上。Master 在 SCL 为高电平时读取 SDA 线上的数据。

5. **从机传送数据字节 (Byte)：** 这个过程会重复进行，**从机每次传送一个字节 (8 个位) 的数据。**

6. Master 发送应答 (ACK) 或非应答 (Not Acknowledge, NACK)：

    在接收到每个字节的数据后，Master 可以选择发送 ACK 或 NACK。

   - **ACK:** 表示 Master 希望继续接收下一个字节的数据。Master 会在下一个时钟周期将 SDA 线拉低。
   - **NACK:** 表示 Master 不再需要接收更多数据。Master 会在下一个时钟周期将 SDA 线保持在高电平。

7. **Master 发送停止 (STOP) 信号：** 当 Master 完成数据接收后，会在 SCL 维持在高电平时，在 SDA 线上产生一个由低电平到高电平的跳变。这个信号通知所有从机，本次通信结束。

在 I²C 中，**Master 总是主动发起读取操作**。Master 并不会等待从机主动告知要发送数据。如果 Master 需要从某个从机获取数据，它必须主动发送包含该从机地址和读取指令的消息来启动数据传输。

## 异步通信与同步通信的区别

**异步通信 (如 UART):** 的确因为不知道数据何时到达，所以需要通过轮询接收数据寄存器的状态或者开启接收中断来实时监测是否有数据到达。这种方式的特点是通信双方不需要共享同一个时钟信号，而是通过起始位、数据位、校验位和停止位等约定好的格式来同步每个字节的数据传输。

**同步通信 (如 I²C 和 SPI):** 的核心特点就是**通信双方共享一个时钟信号**，通常由主机提供。数据在时钟信号的特定时序（例如上升沿或下降沿）被发送和接收。

- **I²C:** 正如您所说，无论是读操作还是写操作，数据的传输都是在 SCL 线的特定时机完成的。主机通过控制 SCL 的时钟频率和时序来同步数据的传输。
- **SPI:** SPI 的全双工特性也依赖于时钟信号的同步。在主机提供的时钟信号的驱动下，主机在发送数据的同时，从机也在同步地发送数据。

