# Clash知识

## 系统代理 / Tun 模式

### 入站

**入站流量**指的是从**本地**网络请求向**本地**代理程序发送的流量。简单来说，就是本地应用程序发出的网络请求**如何被代理程序捕获和处理。**

### 代理模式

代理模式决定了本地网络请求**如何抵达**监听在本地的代理程序。常见的代理模式包括**系统代理和 TUN 模式**。

### 系统代理

系统代理模式是**依赖操作系统的“约定”**，也就是说：

- **约定俗成的位置**：系统代理程序会在**操作系统的特定位置（如注册表、系统变量等）设置代理信息**。这些位置是约定俗成的，各个应用程序可以读取这些位置来获取代理设置。
- **应用程序遵守约定**：如果应用程序遵守这种“约定”，它会**自动读取这些代理设置，并将其网络请求通过代理程序发送出去。**
- **应用程序不遵守约定**：如果应用程序不遵守这种“约定”，或者其设计者选择不使用系统代理，那么**这些网络请求就不会通过代理程序，而是直接连接到目标服务器。这意味着代理程序无法处理这些请求。**

系统代理模式的局限性在于，它依赖于应用程序本身是否愿意遵守系统的代理设置。如果应用程序不遵守，系统代理就无法捕获和代理这些请求。

### 举例说明

- **浏览器**：大多数现代浏览器（如Chrome、Firefox）都支持系统代理设置。当系统代理设置好后，这些浏览器会**自动读取并使用代理进行网络请求**。（所以说浏览器可以代理在上面的各种网络请求）
- **特定应用**：一些应用程序，尤其是一些游戏或定制的网络工具，**可能不会使用系统代理设置**。它们可能有自己内置的网络配置或不使用代理功能。在这种情况下，系统代理就无法捕获这些应用程序的流量。**通常不能代理`UDP`流量（如游戏数据包）。**
- **这正是为什么有些应用程序可以使用代理，而有些则不能使用代理的原因。**

### Tun 模式

为了确保所有应用程序的流量都能被代理，可以使用以下方法：

**TUN 模式**：

- 创建一个虚拟网卡，将所有网络请求重定向到代理程序。
- 这种方法不依赖于应用程序是否遵守系统代理设置，**能够捕获所有的网络流量，包括TCP和UDP流量**。

TUN 模式代理通过创建虚拟网卡，并通过配置操作系统的路由将网络请求重定向到这张虚拟网卡。代理程序从虚拟网卡中读取并处理这些网络请求。

1. **流量拦截**：能够拦截和处理所有流量，包括TCP和UDP。
2. **无需额外配置**：网络请求程序无需额外配置，所有流量都会被重定向到本地代理程序。
3. **不依赖开发人员**：该步骤发生在网络请求程序发出请求之后，因此不依赖开发人员的意愿。

### 使用 TUN 模式的场景

- **在线游戏**：许多在线游戏使用UDP协议来传输数据包，而**系统代理通常只能处理TCP流量**。TUN 模式能够代理包括UDP在内的所有流量，因此特别适合在线游戏。
- **不支持系统代理的应用**：一些应用程序不支持系统代理或没有配置选项，TUN 模式可以确保这些应用程序的流量也能通过代理服务器。

## 规则/ 全局 / 直连模式

路由模式决定了本地代理程序如何处理和转发捕获到的网络请求**（针对的是本地被捕获的要出去的网络请求）**，即决定了“出站”流量的处理方式。

这涉及到**如何将代理程序捕获到的流量发送到目标服务器**。常见的出站模式包括**规则模式、全局模式和直连模式**。

### 规则模式

**功能**：根据配置文件中的规则集进行条件匹配，决定流量是通过哪个代理节点（**这个在程序提供的规则集中已经有了，包含了中国大部分不需要代理以及需要特殊节点代理的配置,订阅链接自带的规则（OpenAI,telegram）,其他需要代理的请求使用用户手动选择的代理节点**）或直接从本地网络出去。

**细节**：

- 用户可以在配置文件中定义多种规则，例如根据域名、IP地址、端口等进行匹配。
- 每个匹配规则可以指定一个特定的代理节点或者直接连接（直连）。

**应用场景**：适用于需要灵活管理流量的情况。例如，可以设置某些特定的网站或应用流量通过代理，而其他流量直连。（流量不够用的情况下，国内走直连，国外走代理，**但是配置太麻烦，现在好像有自动识别哪一些需要代理，哪一些不需要代理。**）

### 全局模式

**功能**：所有流量均通过**手工选定的代理节点（**已经设置了：在代理程序中设置使用哪一个地区的节点做代理**）**或本地网络出去。

**细节**：

- **用户手动选择一个代理节点，所有流量都会通过这个节点转发。**
- 无需复杂的规则匹配，适用于需要简单统一的代理设置。

**应用场景**：适用于需要全面代理所有流量的情况，例如访问受限地区的网络资源或需要统一加密所有通信的场景。**（还是自动识别比较好，本来很快非得绕一圈得不偿失。但是开启全局代理一定是要访问受限地区的网络资源）。**

### 直连模式（相当于关掉代理了）

**功能**：所有流量均直接从本地网络出去，不经过任何代理节点。

**细节**：

- 适用于访问本地网络资源或不需要代理的服务。
- 提高连接速度，减少延迟，因为流量不需要经过代理服务器。

**应用场景**：**适用于无需代理服务的情况**，例如局域网内的设备通信或访问可信的本地服务。

## 服务模式详解（安装更保险一点）

**目的**：

- 服务模式允许用户在非管理员身份下启动 TUN 模式，这是通过让服务进程继承管理员权限来实现的。

**工作原理**：

- 以管理员身份安装并启动服务模式。
- 服务模式启动后，由具有管理员权限的服务进程来“拉起”代理内核程序。
- 代理内核程序作为服务进程的子进程，继承了管理员权限，从而能够执行需要管理员权限的操作，如创建虚拟网卡。

**使用场景**：

- 当用户没有管理员权限但需要启动 TUN 模式时，使用服务模式是必需的。
- 当用户有管理员权限或处于管理员分组下，可以直接启动 TUN 模式，无需使用服务模式。

**UN 模式堆栈**：

- 默认堆栈是 Gvisor。
- 如果需要切换到 System 或 Mixed 堆栈，则需要安装服务模式。

### 简单总结

- **非管理员用户**：需要安装并使用服务模式来启动 TUN 模式。
- **管理员用户**：可以直接启动 TUN 模式，无需使用服务模式。
- **不同的 TUN 模式堆栈**：切换到 System 或 Mixed 堆栈需要服务模式，即使是管理员用户。
- 通过应用程序的网络请求代理效果来看是否代理成功，一般来讲是可以代理的，开启TUN模式加全局模式。如果没有代理成功，说明TUN模式没有成功开启（还是安装服务模式保险一点）

## 终端请求进行代理

Windows CMD（命令提示符）的网络请求没有被 TUN 模式和全局模式捕获并代理，但通过手动设置 HTTP 和 HTTPS 代理环境变量，并使用规则模式和系统代理，可以成功访问 Telegram 官网（**从cmd中启动一个程序我觉得还是要用tun模式加全局模式。因为应用程序并不是在cmd中发出请求的，所以没法代理**）。这说明对于终端（命令提示符）**需要单独进行代理设置**。

### 原因分析

1. **TUN 模式**：虽然 TUN 模式可以捕获大部分网络流量，但在某些情况下，特定应用（如命令提示符）的流量可能不会被正确捕获和代理。
2. **系统代理**：系统代理设置通过环境变量（如 `http_proxy` 和 `https_proxy`）强制应用程序使用指定的代理服务器，这对于命令提示符和其他命令行工具非常有效。

### 解决方案

为了确保命令提示符中的网络请求能够通过代理，你可以继续使用系统代理和规则模式，并手动设置 HTTP 和 HTTPS 代理环境变量。

### 设置永久的环境变量

set命令只能对单个窗口生效，是临时环境变量。使用setx就能写入系统变量中，永久生效。

## win上的系统应用的代理问题

**所以对于clash的规则模式，只适用于浏览器的请求，但是像win10系统上的应用和终端似乎不起作用？而开始全局模式，应用似乎有一些可以，但是终端需要在系统环境设置单独配置才行。**

没错，Clash的规则模式主要作用于浏览器流量，因为这些流量通过系统代理或浏览器代理配置可以直接转发给Clash处理。而对于Win10系统的应用和终端流量，它们并不总是自动遵循系统代理设置，所以很多应用在规则模式下不会走Clash的代理。

当你切换到全局模式时，Clash会尝试将所有网络请求（包括应用和终端的流量）通过代理转发，因此部分应用可以正常使用。但是终端（例如 PowerShell 或 CMD）通常不会默认使用系统代理，需要在系统环境中单独配置才能生效。

**如果用代理，可以直接在系统设置代理，Thunderbird会自动使用 怎么实现？**

在Windows 10上，你可以直接通过系统设置来开启代理，这样像Thunderbird等应用会自动使用这个代理。

以下是具体步骤：

1. **打开系统代理设置**：
   - 进入 **“设置”** > **“网络和Internet”** > **“代理”**。
2. **设置手动代理**：
   - 在“手动代理设置”部分，开启“使用代理服务器”选项。
   - 填写代理服务器的 **地址** 和 **端口**，例如 `127.0.0.1` 和 Clash 本地代理端口（通常为 `7890`）。
3. **保存设置**：
   - 完成设置后，点击“保存”以使代理生效。

设置完成后，Windows系统的应用（如Thunderbird）会自动使用系统代理。



**如果这样的话，只要我开启了clash的代理无论规则还是全局模式，都会代理吗？**

是的，一旦在系统设置中配置了代理地址和端口，Windows系统会尝试将所有通过系统代理的流量发送到Clash。这样无论你在Clash中使用的是**规则模式**还是**全局模式**，都会根据Clash的配置文件处理流量：

1. **规则模式**：Clash会根据你配置的规则来分流，比如对某些特定域名走代理，而其他请求不走代理。这种模式下，只有符合规则的请求会经过代理，其余的请求则直接访问。
2. **全局模式**：Clash会将所有流量都强制通过代理，忽略规则的具体设置，适用于需要全局翻墙或所有流量都需要代理的场景。

如果系统代理开启并配置了Clash的代理地址和端口，Thunderbird等支持系统代理的应用都会自动使用该代理，不需要单独配置。



**所以我配置系统代理后，开启clash的规则模式，是否走代理取决于clash配置的规则？**

​	完全正确！在系统代理配置了Clash的代理地址和端口后，**是否走代理就取决于Clash的规则设置**。

具体来说：

- **规则模式下**，Clash会按照配置文件中的规则判断哪些请求需要走代理、哪些不需要。例如，如果你配置了某些域名或 IP 走代理（如境外流量），只有这些符合规则的请求才会走代理，其他请求则会被直接放行。
- 如果系统应用（如 Thunderbird）发出的请求符合你在 Clash 中定义的代理规则，那么这些请求会走代理；如果不符合规则，则请求会直接通过系统网络访问，不会经过代理。

总结就是：系统代理设置生效后，Clash 的规则模式将根据你定义的规则动态决定流量的转发方式。



**所以如何查看clash的规则配置文件？**

​	在Clash中，当你使用订阅链接获取配置文件后，通常可以在Clash客户端中**选择编辑规则**，以便更好地自定义流量的分流方式。以下是如何进行规则编辑的步骤：

1. **选择订阅并加载配置**

- 打开 **Clash for Windows** 客户端。
- 在 “Profiles” 或 “订阅” 标签页中，选择已加载的配置文件（通常是通过订阅链接导入的 `config.yaml` 文件）。
- 选定配置文件后，可以点击配置右边的**编辑图标**或**编辑按钮**进入规则编辑界面。

2. **编辑规则**

- Clash会显示当前配置文件中的规则，你可以在这里对规则进行修改、添加或删除。
- 规则的格式一般遵循以下几种格式：
  - `DOMAIN,example.com,Proxy`：针对指定域名 `example.com` 走 `Proxy` 节点。
  - `DOMAIN-SUFFIX,google.com,DIRECT`：所有 `google.com` 子域名都直连。
  - `GEOIP,CN,DIRECT`：针对中国大陆的IP走直连。
  - `MATCH,Proxy`：所有未匹配规则的流量走 `Proxy`。

3. **添加或修改规则**

- 根据需求调整规则顺序和内容，规则是**按顺序匹配的**，所以越具体的规则放在前面越优先。
- 可以根据自己的需求，调整让特定域名或IP走代理或直连。

4. **保存并应用规则**

- 编辑完成后，点击“保存”或“应用”按钮。
- Clash会重新加载配置文件，应用最新规则。

5. **验证规则效果**

- 在 **“Logs”**（日志）页面查看流量记录，确认流量是否按照新的规则分流。
- 通过日志查看具体的域名是否走了预期的代理或直连，可以帮助验证规则设置是否正确。

通过编辑订阅配置的规则，可以灵活控制流量，让不同的应用、网站流量按需走代理或直连，提高代理的效率和灵活性。

### 代理位置的区别

**在bash窗口中设置代理端口和在windows10系统上的设置中设置代理端口是不是不一样？**
**如果在bash中设置，只是bash中的网络通信走代理。如果在windows10中设置代理的话，是不是所有应用都走代理？还是需要走代理的应用会选择走？**

是的，在 Bash 窗口中设置代理和在 Windows 10 系统设置中设置代理是不同的：

1. **在 Bash 中设置代理**：

   - 当你通过 Bash 窗口设置代理时（例如，使用 `export http_proxy="http://proxyserver:port"`），这个设置仅对当前的 Bash 会话有效。
   - 只有通过这个 Bash 会话发起的网络请求会走代理。其他应用程序或其他终端会话不会受到影响。
   - 这种设置方式通常用于命令行工具、脚本来访问网络资源。

2. **在 Windows 10 中设置代理**：

   - 在 Windows 10 的系统设置中设置代理（通过“设置” -> “网络和Internet” -> “代理”），这个设置会影响系统级别的网络请求。

   - 所有使用 Windows 网络堆栈的应用程序

     理论上都会使用这个代理设置。这包括浏览器、系统更新、某些应用等。但是：

     - 并非所有应用程序都会遵循这个设置。一些应用程序（特别是那些有自己网络处理的，比如某些游戏或特定的企业软件）可能忽略系统代理设置，继续直接连接。
     - 一些应用可能会有自己的代理设置选项，用户可以选择是否使用系统代理或者设置自己的代理。
     - 现代应用程序（尤其是UWP应用）通常会尊重系统的代理设置，但传统的桌面应用程序可能会有不同的行为。

总之，在 Windows 10 中设置代理：

- **大部分**应用会遵循这个设置，但不是所有。
- 一些应用可能会需要额外配置或有自己的代理设置选项。
- 如果某个应用确实需要使用代理但没有遵循系统设置，用户通常需要在该应用内部进行设置。

因此，如果你希望特定应用程序使用代理，最好同时在系统设置和应用程序内部进行配置，以确保网络请求正确通过代理服务器。

### 大陆ip不使用代理服务器（没用？）

我想设置一下windows10上的代理，但是中国大陆的地址都采用直连方式，
我总结出这一些：你可以完善一下
`localhost;127.*;192.168.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*`

你的列表已经包含了大部分的私有IP地址范围和本地主机地址，用于确保这些地址不会通过代理访问。以下是完善后的列表：

- `localhost`
- `127.*`（这个已经包含了127.0.0.1等所有127开头的地址）
- `192.168.*`（这个已经包含了所有192.168.x.x的地址）
- `10.*`（这个已经包含了所有10.x.x.x的地址）
- `172.16.*`到`172.31.*`（你已经列出了全部16个范围）

此外，你还可以考虑以下几点来进一步完善：

1. **IPv6的本地地址**:

   - `::1`（IPv6的本地回环地址）

2. **常见的域名**：

   - 一些常见的中国大陆域名，比如`.cn`、`.com.cn`、`.edu.cn`等，这些通常需要直连。具体的域名列表取决于你的需求和公司的政策。

3. **特定IP地址**：

   - 如果你知道某些特定IP地址或IP段需要直连，可以直接添加这些地址。

4. **系统自动检测**：

   - 一些系统会自动检测局域网内的地址，你可以考虑是否需要包含这些。

5. 静态链表

   - ```c
     localhost;127.*;192.168.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*
     ```


### 检测系统级别的代理(设置了没看到效果)

**检查系统代理设置**：

- 你可以使用`netsh`命令来查看系统级的代理设置（这些设置会影响WinHTTP的应用程序）：

- ```
  netsh winhttp show proxy
  ```

- 如果你看到代理设置显示为“Direct access (no proxy server)”，意味着没有设置代理。如果有设置，你会看到代理服务器的地址和端口。

**查看环境变量**：

- 有些应用程序会读取环境变量来决定是否使用代理。你可以通过以下命令来查看环境变量：

- ```
  echo %http_proxy%
  echo %HTTP_PROXY%
  echo %https_proxy%
  echo %HTTPS_PROXY%
  ```

- 如果这些变量有值，说明可能有应用程序配置了代理。

**使用`tracert`或`ping`命令**：

- 虽然不是直接检查代理设置的方式，但你可以通过`tracert`或`ping`命令查看网络请求是否通过代理服务器：

- ```
  tracert google.com
  ```

- 如果你的请求确实通过代理服务器，那么`tracert`可能会显示代理服务器的IP地址作为第一个跳转点。

**请注意，这些方法中有些是间接检查的方式，而`netsh winhttp show proxy`是最直接的查看系统代理设置的方式。如果你使用的是第三方代理软件或者特定应用程序的代理设置，可能需要在那些软件或应用程序内查看。**

#### 设计系统级别

是的，你可以将这些代理信息设置到Windows的系统级别上，这样系统中使用WinHTTP的应用程序将能够使用这个代理服务器。以下是如何在Windows上设置这些环境变量：

**使用命令提示符（CMD）设置环境变量**：

- 打开命令提示符（你可以按Win+R，输入`cmd`并按回车）。
- 使用以下命令设置代理环境变量：

```bash
setx http_proxy "http://127.0.0.1:7897"
setx https_proxy "http://127.0.0.1:7897"
```

- `setx`命令会将这些变量设置为系统环境变量，而不是仅限于当前的CMD会话。

**设置系统代理**：

```
netsh winhttp set proxy 127.0.0.1:7897
```

如果需要直连地址列表，可以加上：

```
netsh winhttp set proxy 127.0.0.1:7897 "localhost;127.*;192.168.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*"
```

请注意：

- 确保在运行这个命令之前，Clash（或你使用的代理软件）正在运行并监听在`127.0.0.1:7897`这个端口。
- 这个命令设置的是系统级别的代理，适用于使用WinHTTP的应用程序。
- 你之前设置的环境变量（`http_proxy`和`https_proxy`）已经涵盖了设置代理的需求，因此不需要再重复设置。

执行此命令后，系统中使用WinHTTP的应用程序将会通过你指定的代理服务器进行网络请求，同时直连列表中的地址将直接访问，不通过代理。
